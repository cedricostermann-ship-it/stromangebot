<iframe
  id="tw24SurveyFrame"
  src="https://cedricostermann-ship-it.github.io/stromangebot/?v=20260107-53"
  style="width:100%; height:78vh; border:1px solid rgba(0,0,0,.12); border-radius:18px; background:#fff; display:block; overflow:hidden;"
  loading="lazy"
  title="Tarifwechsel24 Quiz"
></iframe>

<script>
  (function(){
    const frame = document.getElementById("tw24SurveyFrame");
    if (!frame) return;

    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    let lastSet = 0;

    // Anti-Loop Schutz (falls irgendwas trotzdem spammt)
    let burstStart = performance.now();
    let burstCount = 0;

    function applyHeight(h){
      const next = clamp(h, 420, 3000);
      if (Math.abs(next - lastSet) < 10) return;
      lastSet = next;
      frame.style.height = next + "px";
    }

    function onMsg(event){
      if (!event.data || event.data.type !== "TW24_HEIGHT") return;
      if (event.source !== frame.contentWindow) return;

      const h = Number(event.data.height);
      if (!h || h < 300) return;

      const now = performance.now();
      if (now - burstStart > 2500){
        burstStart = now;
        burstCount = 0;
      }
      burstCount++;

      // Wenn >20 Updates in 2.5s: stoppt Listener, setzt einmal final und fertig
      if (burstCount > 20){
        applyHeight(h);
        window.removeEventListener("message", onMsg);
        return;
      }

      applyHeight(h);
    }

    window.addEventListener("message", onMsg);
  })();
</script>
