<!doctype html>
<html lang="de">

<body>
  <div class="wrap">
    <div class="logo">
      <strong style="font-size:22px;">Tarifwechsel<span style="color:#66b21d;">24</span></strong>
    </div>

    <div class="card">
      <div class="progress"><div class="bar" id="bar"></div></div>

      <div id="err" class="error"></div>

      <!-- STEP 1 -->
      <section class="step" data-step="1">
        <h1 class="h1line">ğŸ” Ihr persÃ¶nliches Stromangebot in 2&nbsp;Minuten âš¡</h1>
        <p class="sub">Kostenlos Â· unverbindlich Â· persÃ¶nlich geprÃ¼ft</p>
        <div class="spacer"></div>

        <label for="plz">ğŸ‘‰ Postleitzahl</label>
        <input id="plz" inputmode="numeric" autocomplete="postal-code" placeholder="z. B. 10115" maxlength="5" />

        <div class="btnrow">
          <button class="primary" id="to2">Weiter â†’</button>
        </div>
      </section>

      <!-- STEP 2 -->
      <section class="step hidden" data-step="2">
        <h1>Sind Sie Privat- oder Gewerbekunde?</h1>
        <p class="sub">Gewerbe- und Privatkunden haben unterschiedliche Tarife & Konditionen.</p>
        <div class="spacer"></div>

        <div class="choices" id="customerType">
          <div class="chip" data-value="Privat">Privat</div>
          <div class="chip" data-value="Gewerbe">Gewerbe</div>
        </div>

        <div class="btnrow nav">
          <button class="ghost" id="back1">â† ZurÃ¼ck</button>
          <button class="primary" id="to3">Weiter â†’</button>
        </div>
      </section>

      <!-- STEP 3 PRIVAT -->
      <section class="step hidden" data-step="3p">
        <h1 class="h1line">Wie hoch ist Ihr jÃ¤hrlicher Stromverbrauch?</h1>
        <p class="sub">Falls Sie es nicht genau wissen: grobe SchÃ¤tzung reicht.</p>
        <div class="spacer"></div>

        <div class="choices" id="usagePrivate">
          <div class="chip" data-value="Bis 2.000 kWh">Bis 2.000 kWh</div>
          <div class="chip" data-value="2.000 â€“ 3.500 kWh">2.000 â€“ 3.500 kWh</div>
          <div class="chip" data-value="3.500 â€“ 5.000 kWh">3.500 â€“ 5.000 kWh</div>
          <div class="chip" data-value="Ãœber 5.000 kWh">Ãœber 5.000 kWh</div>
          <div class="chip" data-value="WeiÃŸ ich nicht">WeiÃŸ ich nicht</div>
        </div>

        <div class="btnrow nav">
          <button class="ghost" id="back2a">â† ZurÃ¼ck</button>
          <button class="primary" id="to4a">Weiter â†’</button>
        </div>
      </section>

      <!-- STEP 3 GEWERBE -->
      <section class="step hidden" data-step="3g">
        <h1 class="h1line">Wie hoch ist Ihr jÃ¤hrlicher Stromverbrauch?</h1>
        <p class="sub">Richtwert genÃ¼gt â€“ wir klÃ¤ren Details im GesprÃ¤ch.</p>
        <div class="spacer"></div>

        <div class="choices" id="usageBusiness">
          <div class="chip" data-value="Bis 50.000 kWh">Bis 50.000 kWh</div>
          <div class="chip" data-value="50.000 â€“ 100.000 kWh">50.000 â€“ 100.000 kWh</div>
          <div class="chip" data-value="Ãœber 100.000 kWh">Ãœber 100.000 kWh</div>
        </div>

        <div class="btnrow nav">
          <button class="ghost" id="back2b">â† ZurÃ¼ck</button>
          <button class="primary" id="to4b">Weiter â†’</button>
        </div>
      </section>

      <!-- STEP 4 CONTACT -->
      <section class="step hidden" data-step="4">
        <h1 class="h1line">âš¡ Fast geschafft â€“ wir erstellen jetzt Ihr Stromangebot</h1>
        <p class="sub">Ein Energieberater meldet sich kurz, um die besten Optionen zu bestÃ¤tigen.</p>
        <div class="spacer"></div>

        <label for="name">Vor- & Nachname *</label>
        <input id="name" autocomplete="name" placeholder="Max Mustermann" />

        <label for="phone">Telefonnummer *</label>
        <input id="phone" inputmode="tel" autocomplete="tel" placeholder="0176 12345678" />

        <label>Wie mÃ¶chten Sie kontaktiert werden? (optional)</label>
        <div class="choices" id="contactPref">
          <div class="chip" data-value="Telefon">Telefon</div>
          <div class="chip" data-value="WhatsApp">WhatsApp</div>
          <div class="chip" data-value="E-Mail">E-Mail</div>
        </div>

        <div class="check">
          <input id="consent" type="checkbox" />
          <div class="small">
            Ich willige ein, dass meine Angaben zur Erstellung eines Stromangebots verarbeitet werden und ich hierzu telefonisch,
            per WhatsApp oder per E-Mail kontaktiert werde. Weitere Informationen in der
            <a href="/datenschutz" target="_blank" rel="noopener">DatenschutzerklÃ¤rung</a>.
            <span style="color:#b42318;">*</span>
          </div>
        </div>

        <div class="btnrow nav">
          <button class="ghost" id="back3">â† ZurÃ¼ck</button>
          <button class="primary" id="submit">Stromangebot anfordern â†’</button>
        </div>

        <div class="small">Kostenlos & unverbindlich. Kein Spam.</div>
      </section>

      <!-- THANK YOU -->
      <section class="step hidden" data-step="5">
        <h1>âœ… Danke! Anfrage erhalten.</h1>
        <p class="sub">Unser Energieberater setzt sich in KÃ¼rze mit Ihnen in Verbindung.</p>
        <div class="spacer"></div>

        <div class="btnrow">
          <a class="primary"
             style="display:inline-block;text-decoration:none;padding:14px 14px;border-radius:12px;width:100%;font-weight:900;"
             id="waLink" href="#" target="_blank" rel="noopener">Optional: per WhatsApp schreiben</a>
        </div>

        <div class="spacer"></div>
        <div class="small">Hinweis: WhatsApp ist freiwillig.</div>
      </section>

    </div>
  </div>

<script>
  const WEBHOOK_URL = "PASTE_YOUR_WEBHOOK_URL_HERE";
  const WA_NUMBER = "4917672530039";

  const state = { plz:"", type:"", usage:"", name:"", phone:"", pref:"" };

  const $ = (id) => document.getElementById(id);
  const steps = Array.from(document.querySelectorAll(".step"));
  const err = $("err");
  const bar = $("bar");

  function showError(msg){
    err.textContent = msg;
    err.style.display = "block";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  function clearError(){ err.style.display = "none"; err.textContent=""; }

  function setActive(containerId, value){
    const el = $(containerId);
    el.querySelectorAll(".chip").forEach(c => c.dataset.active = (c.dataset.value === value) ? "true" : "false");
  }

  function currentProgress(stepKey){
    const map = { "1": 20, "2": 40, "3p": 60, "3g": 60, "4": 85, "5": 100 };
    bar.style.width = (map[stepKey] || 0) + "%";
  }

  // âœ… Height sender (nur sichtbarer Inhalt, nicht scrollHeight)
  function sendEmbedHeight(){
    const wrap = document.querySelector(".wrap");
    const card = document.querySelector(".card");
    if(!wrap || !card) return;

    const wrapRect = wrap.getBoundingClientRect();
    const cardRect = card.getBoundingClientRect();

    // HÃ¶he = von oben wrap bis unten card + bisschen Luft
    const h = Math.ceil((cardRect.bottom - wrapRect.top) + 16);

    window.parent && window.parent.postMessage({ type: "TW24_HEIGHT", height: h }, "*");
  }

  function go(stepKey){
    clearError();
    steps.forEach(s => s.classList.add("hidden"));
    document.querySelector(`.step[data-step="${stepKey}"]`).classList.remove("hidden");
    currentProgress(stepKey);

    // âœ… wichtig: nach jedem Stepwechsel neue HÃ¶he schicken
    setTimeout(sendEmbedHeight, 20);
    setTimeout(sendEmbedHeight, 120);
  }

  // Step 2 selection
  $("customerType").addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip"); if(!chip) return;
    state.type = chip.dataset.value;
    setActive("customerType", state.type);
    setTimeout(sendEmbedHeight, 20);
  });

  // Usage selections
  $("usagePrivate").addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip"); if(!chip) return;
    state.usage = chip.dataset.value;
    setActive("usagePrivate", state.usage);
    setTimeout(sendEmbedHeight, 20);
  });
  $("usageBusiness").addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip"); if(!chip) return;
    state.usage = chip.dataset.value;
    setActive("usageBusiness", state.usage);
    setTimeout(sendEmbedHeight, 20);
  });

  // Contact pref (optional)
  $("contactPref").addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip"); if(!chip) return;
    state.pref = chip.dataset.value;
    setActive("contactPref", state.pref);
    setTimeout(sendEmbedHeight, 20);
  });

  // Buttons
  $("to2").onclick = () => {
    const plz = $("plz").value.trim();
    if(!/^\d{5}$/.test(plz)) return showError("Bitte eine gÃ¼ltige Postleitzahl (5 Ziffern) eingeben.");
    state.plz = plz;
    go("2");
  };

  $("back1").onclick = () => go("1");

  $("to3").onclick = () => {
    if(!state.type) return showError("Bitte wÃ¤hlen Sie Privat oder Gewerbe.");
    if(state.type === "Privat") go("3p"); else go("3g");
  };

  $("back2a").onclick = () => go("2");
  $("back2b").onclick = () => go("2");

  $("to4a").onclick = () => {
    if(!state.usage) return showError("Bitte wÃ¤hlen Sie eine Verbrauchsangabe.");
    go("4");
  };
  $("to4b").onclick = () => {
    if(!state.usage) return showError("Bitte wÃ¤hlen Sie eine Verbrauchsangabe.");
    go("4");
  };

  $("back3").onclick = () => {
    if(state.type === "Privat") go("3p"); else go("3g");
  };

  $("submit").onclick = async () => {
    state.name = $("name").value.trim();
    state.phone = $("phone").value.trim();
    const consent = $("consent").checked;

    if(!state.name) return showError("Bitte Vor- & Nachname eintragen.");
    if(state.phone.length < 6) return showError("Bitte eine gÃ¼ltige Telefonnummer eintragen.");
    if(!consent) return showError("Bitte bestÃ¤tigen Sie die Datenschutzeinwilligung.");

    const payload = {
      plz: state.plz,
      kundentyp: state.type,
      verbrauch: state.usage,
      name: state.name,
      telefon: state.phone,
      kontaktpraeferenz: state.pref || "",
      timestamp: new Date().toISOString(),
      source: location.href
    };

    const msg = encodeURIComponent(`Hi, ich habe gerade ein Stromangebot angefordert. PLZ: ${state.plz}`);
    $("waLink").href = `https://wa.me/${WA_NUMBER}?text=${msg}`;

    try{
      if(WEBHOOK_URL && WEBHOOK_URL.startsWith("http")){
        await fetch(WEBHOOK_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload),
          keepalive: true
        });
      }
      go("5");
    }catch(e){
      showError("Ups â€“ technisch gab es kurz ein Problem. Bitte versuchen Sie es erneut oder kontaktieren Sie uns direkt.");
      console.error(e);
    }
  };

  // initial
  window.addEventListener("load", () => {
    go("1");
    setTimeout(sendEmbedHeight, 120);
  });
  window.addEventListener("resize", () => setTimeout(sendEmbedHeight, 80));
</script>

</body>
</html>
